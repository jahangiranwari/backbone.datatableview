/*!
 * Backbone.DataTableView
 *
 * Copyright (c)2013 Jahangir Anwari
 * Dual licensed under the MIT and GPLv2 licenses.
 *
 * This source file is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the license files for details.
 */
!function(a,b,c){"use strict";var d,e,f;d=c.Events,c.DataTableView=c.View.extend({template:'<div class="errors"></div><div class="modal-form"></div><table class="table table-striped table-bordered"></table>',addButton:'<button class="btn bdt-add" data-toggle="modal">Add</button>',editButton:'<button class="btn btn-mini bdt-edit">Edit</button>',deleteButton:'<button class="btn btn-danger btn-mini bdt-delete">Delete</button>',preRenderInitialize:function(){b.bindAll(this,"render","renderDataTable","renderEditDeleteColumn","handleError"),d.on("create"+this.cid,this.createRow,this),d.on("update"+this.cid,this.updateRow,this),this.$el.html(this.template),this.$table=this.$("table"),this.disableAdd||this.$el.prepend(this.addButton)},events:{"click .bdt-add":"addRow","click .bdt-edit":"editRow","click .bdt-delete":"deleteRow"},defaultDataTableOptions:{sDom:'<"row"<"span4"l><"pull-right"f>r>t<"row-fluid"<"span5"i><"span7"p>>',aaSorting:[],bDestroy:!0},render:function(){if(!this.dataTableOptions.aoColumnDefs||0===this.dataTableOptions.aoColumnDefs.length)throw new Error('"aoColumnDefs" not found. Please define DataTables aoColumnDefs');return this.preRenderInitialize(),0===this.collection.length?this.collection.fetch({success:this.renderDataTable,error:this.handleError}):this.renderDataTable(null,this.collection.toJSON()),this},renderDataTable:function(a,b){var c=this.mergeDataTableOptions(b);this.$table.dataTable(c)},addRow:function(){var a=new this.collection.model;this.createAndRenderFormView(a)},createRow:function(a){this.collection.add(a),this.$table.fnAddData(a.toJSON())},editRow:function(b){var c,d;c=this.getModelId(a(b.currentTarget)),d=this.collection.get(c),this.createAndRenderFormView(d)},updateRow:function(a){var b=this.collection.indexOf(a);this.$table.fnUpdate(a.toJSON(),b,void 0,!1,!1)},deleteRow:function(c){var d,e,f,g,h;g=b.isFunction(this.beforeDelete)?this.beforeDelete():!0,g&&(e=this.getModelId(a(c.currentTarget)),f=this.collection.get(e),h=this.collection.indexOf(f),d=this,f.destroy({success:function(){d.$table.fnDeleteRow(h)},error:this.handleError},{wait:!0}))},createAndRenderFormView:function(a){var b=new c.DataTableFormView({model:a,template:this.formTemplate,tableViewCid:this.cid,serialize:this.serialize,compiledTemplate:this.compileTemplate,renderError:this.renderError});this.displayModalForm(b)},displayModalForm:function(a){this.$("div.modal-form").html(a.render().el),this.$("div.modal").modal("show")},handleError:function(a,b){f(b.responseText,this)},renderEditDeleteColumn:function(){var a;return a=this.disableEdit?this.deleteButton:this.disableDelete?this.editButton:this.editButton+"	"+this.deleteButton},getModelId:function(a){var b,c;return b=a.closest("tr")[0],c=this.$table.fnGetData(b).id},mergeDataTableOptions:function(a){var c={};return c=b.clone(this.defaultDataTableOptions),b.extend(c,this.dataTableOptions,{aaData:a}),this.disableEditDelete||c.aoColumnDefs.push({mData:null,aTargets:[c.aoColumnDefs.length],bSearchable:!1,bSortable:!1,sClass:"edit-delete",mRender:this.renderEditDeleteColumn}),c},close:function(){this.off(),this.collection.off(null,null,this),this.$table&&a.fn.DataTable.fnIsDataTable(this.$table[0])&&this.$table.fnDestroy(!0),this.remove()}}),c.DataTableFormView=c.View.extend({initialize:function(){var a=this;b.bindAll(this,"handleError"),this.listenTo(this.model,"invalid",this.handleError),this.listenTo(this.model,"sync",this.close),this.$("div.modal").on("hidden hidden.bs.modal",function(){a.remove(),a.$("div.modal").off()})},events:{"click .bdt-save":"save","click .bdt-close":"close"},render:function(){return this.template=this.compileTemplate(this.options.template),this.$el.html(this.template(this.model.toJSON())),this},compileTemplate:function(a){if(!a||0===a.length)throw new Error("Form template not found. Please define a template");return b.isFunction(a)?a:b.template(a)},save:function(){var a=this.model.isNew()?"create":"update";a+=this.options.tableViewCid,this.model.save(this.serialize(),{success:function(b){d.trigger(a,b)},error:this.handleError})},serialize:function(){var a={};return a=this.options.serialize?this.options.serialize.call(this):this.serializeObject()},//! jQuery serializeObject - Copyright 2010 "Cowboy" Ben Alman
serializeObject:function(){var b={};return a.each(this.$("form").serializeArray(),function(c,d){var e=d.name,f=d.value;b[e]=void 0===b[e]?f:a.isArray(b[e])?b[e].concat(f):[b[e],f]}),b},handleError:function(a,c){b.isObject(c)&&c.responseText&&(c=c.responseText),f(c,this)},close:function(){b.isEmpty(this.model.validationError)||(this.model.attributes=this.model.previousAttributes()),this.unbind(),this.$("div.modal").modal("hide")}}),f=function(a,b){if(b.renderError)b.renderError(a);else if(b.options.renderError)b.options.renderError(a);else{var c=e(a);b.$el.find("div.errors").html(c)}},e=function(a){var c;return b.isArray(a)&&a.length>1?(c='<div class="alert alert-error"><ul>',b.each(a,function(a){c+="<li>"+a+"</li>"}),c+="</ul></div>"):c='<p class="alert alert-error">'+a+"</p>",c}}(jQuery,_,Backbone);